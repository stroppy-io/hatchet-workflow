# PostgreSQL Infrastructure Docker Compose
# Supports standalone and Patroni HA cluster modes via profiles.
# All host ports and config parameterized via env vars for multi-deployment on a single VM.
#
# Profiles:
#   standalone        - Plain PostgreSQL (no HA)
#   cluster           - Patroni HA cluster (3 nodes)
#   etcd              - Single etcd node (DCS for patroni)
#   etcd-ha           - 3-node etcd cluster
#   etcd-5            - 5-node etcd cluster
#   pgbouncer         - Connection pooler
#   postgres-exporter - PostgreSQL metrics exporter
#   pgbouncer-exporter- PgBouncer metrics exporter
#   node-exporter     - System metrics exporter
#   filebeat          - Log shipping to Logstash
#   vector            - Log aggregation via Vector
#   backup            - Backup service (pg_dump / wal-g)

x-pg-env: &pg-env
  POSTGRES_USER: ${PG_USER:-postgres}
  POSTGRES_PASSWORD: ${PG_PASSWORD:-postgres}
  POSTGRES_DB: ${PG_DATABASE:-postgres}

x-patroni-env: &patroni-env
  PATRONI_SCOPE: ${CLUSTER_NAME:-pg}
  PATRONI_ETCD3_HOSTS: ${ETCD_HOSTS:-etcd-1:2379}
  PATRONI_SUPERUSER_USERNAME: ${PG_USER:-postgres}
  PATRONI_SUPERUSER_PASSWORD: ${PG_PASSWORD:-postgres}
  PATRONI_REPLICATION_USERNAME: replicator
  PATRONI_REPLICATION_PASSWORD: ${PG_REPLICATION_PASSWORD:-replicator}
  PATRONI_RESTAPI_LISTEN: 0.0.0.0:8008
  PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:5432
  PATRONI_POSTGRESQL_USE_PG_REWIND: "true"
  PATRONI_TTL: ${PATRONI_TTL:-30}
  PATRONI_LOOP_WAIT: ${PATRONI_LOOP_WAIT:-10}
  PATRONI_RETRY_TIMEOUT: ${PATRONI_RETRY_TIMEOUT:-10}
  PATRONI_MAXIMUM_LAG_ON_FAILOVER: ${PATRONI_MAXIMUM_LAG_ON_FAILOVER:-1048576}
  PATRONI_SYNCHRONOUS_MODE: ${PATRONI_SYNCHRONOUS_MODE:-false}
  PATRONI_SYNCHRONOUS_NODE_COUNT: ${PATRONI_SYNCHRONOUS_NODE_COUNT:-1}
  PATRONI_POSTGRESQL_PARAMETERS: '{"password_encryption": "md5"}'
  PATRONI_POSTGRESQL_PG_HBA: "host replication replicator 0.0.0.0/0 md5, host all all 0.0.0.0/0 md5"

x-etcd-env: &etcd-env
  ETCD_INITIAL_CLUSTER: ${ETCD_INITIAL_CLUSTER:-etcd-1=http://etcd-1:2380}
  ETCD_INITIAL_CLUSTER_STATE: new
  ETCD_INITIAL_CLUSTER_TOKEN: ${CLUSTER_NAME:-pg}-etcd
  ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
  ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
  ETCD_DATA_DIR: /etcd-data

x-etcd-healthcheck: &etcd-healthcheck
  test: ["CMD", "etcdctl", "endpoint", "health"]
  interval: 5s
  timeout: 5s
  retries: 10
  start_period: 10s

x-patroni-healthcheck: &patroni-healthcheck
  test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-postgres} || exit 1"]
  interval: 5s
  timeout: 5s
  retries: 20
  start_period: 30s

services:
  # ════════════════════════════════════════
  # STANDALONE PostgreSQL
  # ════════════════════════════════════════
  postgres:
    image: ${PG_IMAGE:-postgres:17}
    profiles: ["standalone"]
    container_name: ${CLUSTER_NAME:-pg}-postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      <<: *pg-env
      PG_EXTRA_PARAMS: ${PG_EXTRA_PARAMS:-}
    command: postgres -c password_encryption=md5 ${PG_EXTRA_PARAMS:-}
    ports:
      - "${PG_PORT:-5432}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - internal
      - stroppy-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-postgres} -d ${PG_DATABASE:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ════════════════════════════════════════
  # ETCD CLUSTER (DCS for Patroni)
  # ════════════════════════════════════════
  etcd-1:
    image: ${ETCD_IMAGE:-quay.io/coreos/etcd:v3.5.17}
    profiles: ["etcd"]
    container_name: ${CLUSTER_NAME:-pg}-etcd-1
    hostname: etcd-1
    restart: unless-stopped
    environment:
      <<: *etcd-env
      ETCD_NAME: etcd-1
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-1:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-1:2379
    ports:
      - "${ETCD1_CLIENT_PORT:-2379}:2379"
    volumes:
      - etcd_1_data:/etcd-data
    networks:
      - internal
    healthcheck: *etcd-healthcheck

  etcd-2:
    image: ${ETCD_IMAGE:-quay.io/coreos/etcd:v3.5.17}
    profiles: ["etcd-ha"]
    container_name: ${CLUSTER_NAME:-pg}-etcd-2
    hostname: etcd-2
    restart: unless-stopped
    environment:
      <<: *etcd-env
      ETCD_NAME: etcd-2
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-2:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-2:2379
    volumes:
      - etcd_2_data:/etcd-data
    networks:
      - internal
    healthcheck: *etcd-healthcheck

  etcd-3:
    image: ${ETCD_IMAGE:-quay.io/coreos/etcd:v3.5.17}
    profiles: ["etcd-ha"]
    container_name: ${CLUSTER_NAME:-pg}-etcd-3
    hostname: etcd-3
    restart: unless-stopped
    environment:
      <<: *etcd-env
      ETCD_NAME: etcd-3
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-3:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-3:2379
    volumes:
      - etcd_3_data:/etcd-data
    networks:
      - internal
    healthcheck: *etcd-healthcheck

  etcd-4:
    image: ${ETCD_IMAGE:-quay.io/coreos/etcd:v3.5.17}
    profiles: ["etcd-5"]
    container_name: ${CLUSTER_NAME:-pg}-etcd-4
    hostname: etcd-4
    restart: unless-stopped
    environment:
      <<: *etcd-env
      ETCD_NAME: etcd-4
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-4:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-4:2379
    volumes:
      - etcd_4_data:/etcd-data
    networks:
      - internal
    healthcheck: *etcd-healthcheck

  etcd-5:
    image: ${ETCD_IMAGE:-quay.io/coreos/etcd:v3.5.17}
    profiles: ["etcd-5"]
    container_name: ${CLUSTER_NAME:-pg}-etcd-5
    hostname: etcd-5
    restart: unless-stopped
    environment:
      <<: *etcd-env
      ETCD_NAME: etcd-5
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-5:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-5:2379
    volumes:
      - etcd_5_data:/etcd-data
    networks:
      - internal
    healthcheck: *etcd-healthcheck

  # ════════════════════════════════════════
  # PATRONI CLUSTER (HA PostgreSQL)
  # ════════════════════════════════════════
  patroni-1:
    build:
      context: .
      dockerfile: patroni.Dockerfile
      args:
        PG_BASE_IMAGE: ${PG_BASE_IMAGE:-postgres:17}
    profiles: ["cluster"]
    container_name: ${CLUSTER_NAME:-pg}-patroni-1
    hostname: patroni-1
    restart: unless-stopped
    environment:
      <<: *patroni-env
      PATRONI_NAME: patroni-1
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: patroni-1:5432
      PATRONI_RESTAPI_CONNECT_ADDRESS: patroni-1:8008
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data/patroni
    ports:
      - "${PATRONI1_PG_PORT:-5432}:5432"
      - "${PATRONI1_API_PORT:-8008}:8008"
    volumes:
      - patroni_1_data:/var/lib/postgresql/data
    networks:
      - internal
      - stroppy-net
    depends_on:
      etcd-1:
        condition: service_healthy
        required: false
    healthcheck: *patroni-healthcheck

  patroni-2:
    build:
      context: .
      dockerfile: patroni.Dockerfile
      args:
        PG_BASE_IMAGE: ${PG_BASE_IMAGE:-postgres:17}
    profiles: ["cluster"]
    container_name: ${CLUSTER_NAME:-pg}-patroni-2
    hostname: patroni-2
    restart: unless-stopped
    environment:
      <<: *patroni-env
      PATRONI_NAME: patroni-2
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: patroni-2:5432
      PATRONI_RESTAPI_CONNECT_ADDRESS: patroni-2:8008
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data/patroni
    ports:
      - "${PATRONI2_PG_PORT:-5433}:5432"
      - "${PATRONI2_API_PORT:-8009}:8008"
    volumes:
      - patroni_2_data:/var/lib/postgresql/data
    networks:
      - internal
      - stroppy-net
    depends_on:
      etcd-1:
        condition: service_healthy
        required: false
    healthcheck: *patroni-healthcheck

  patroni-3:
    build:
      context: .
      dockerfile: patroni.Dockerfile
      args:
        PG_BASE_IMAGE: ${PG_BASE_IMAGE:-postgres:17}
    profiles: ["cluster"]
    container_name: ${CLUSTER_NAME:-pg}-patroni-3
    hostname: patroni-3
    restart: unless-stopped
    environment:
      <<: *patroni-env
      PATRONI_NAME: patroni-3
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: patroni-3:5432
      PATRONI_RESTAPI_CONNECT_ADDRESS: patroni-3:8008
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data/patroni
    ports:
      - "${PATRONI3_PG_PORT:-5434}:5432"
      - "${PATRONI3_API_PORT:-8010}:8008"
    volumes:
      - patroni_3_data:/var/lib/postgresql/data
    networks:
      - internal
      - stroppy-net
    depends_on:
      etcd-1:
        condition: service_healthy
        required: false
    healthcheck: *patroni-healthcheck

  # ════════════════════════════════════════
  # PGBOUNCER (Connection Pooler)
  # ════════════════════════════════════════
  pgbouncer:
    image: ${PGBOUNCER_IMAGE:-edoburu/pgbouncer:latest}
    profiles: ["pgbouncer"]
    container_name: ${CLUSTER_NAME:-pg}-pgbouncer
    hostname: pgbouncer
    restart: unless-stopped
    environment:
      DATABASE_URL: "postgres://${PG_USER:-postgres}:${PG_PASSWORD:-postgres}@${PGBOUNCER_UPSTREAM_HOST:-postgres}:5432/${PG_DATABASE:-postgres}"
      POOL_MODE: ${PGBOUNCER_POOL_MODE:-transaction}
      DEFAULT_POOL_SIZE: ${PGBOUNCER_POOL_SIZE:-20}
      MAX_CLIENT_CONN: ${PGBOUNCER_MAX_CLIENT_CONN:-100}
      LISTEN_PORT: "6432"
    ports:
      - "${PGBOUNCER_PORT:-6432}:6432"
    networks:
      - internal
      - stroppy-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 6432 -U ${PG_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  # ════════════════════════════════════════
  # MONITORING SIDECARS
  # ════════════════════════════════════════
  postgres-exporter:
    image: ${PG_EXPORTER_IMAGE:-prometheuscommunity/postgres-exporter:latest}
    profiles: ["postgres-exporter"]
    container_name: ${CLUSTER_NAME:-pg}-postgres-exporter
    hostname: postgres-exporter
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://${PG_USER:-postgres}:${PG_PASSWORD:-postgres}@${PG_EXPORTER_TARGET:-postgres}:5432/${PG_DATABASE:-postgres}?sslmode=disable"
    ports:
      - "${PG_EXPORTER_PORT:-9187}:9187"
    networks:
      - internal
      - stroppy-net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9187/metrics > /dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  pgbouncer-exporter:
    image: ${PGB_EXPORTER_IMAGE:-prometheuscommunity/pgbouncer-exporter:latest}
    profiles: ["pgbouncer-exporter"]
    container_name: ${CLUSTER_NAME:-pg}-pgbouncer-exporter
    hostname: pgbouncer-exporter
    restart: unless-stopped
    environment:
      PGBOUNCER_EXPORTER_HOST: pgbouncer
      PGBOUNCER_EXPORTER_PORT: "6432"
      PGBOUNCER_EXPORTER_USER: ${PG_USER:-postgres}
      PGBOUNCER_EXPORTER_PASS: ${PG_PASSWORD:-postgres}
    ports:
      - "${PGB_EXPORTER_PORT:-9127}:9127"
    networks:
      - internal
      - stroppy-net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9127/metrics > /dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  node-exporter:
    image: ${NODE_EXPORTER_IMAGE:-prom/node-exporter:latest}
    profiles: ["node-exporter"]
    container_name: ${CLUSTER_NAME:-pg}-node-exporter
    hostname: node-exporter
    restart: unless-stopped
    ports:
      - "${NODE_EXPORTER_PORT:-9100}:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - internal
      - stroppy-net
    pid: host

  # ════════════════════════════════════════
  # LOG SHIPPING SIDECARS
  # ════════════════════════════════════════
#  filebeat:
#    image: ${FILEBEAT_IMAGE:-docker.elastic.co/beats/filebeat:8.17.0}
#    profiles: ["filebeat"]
#    container_name: ${CLUSTER_NAME:-pg}-filebeat
#    hostname: filebeat
#    restart: unless-stopped
#    user: root
#    command: >
#      filebeat -e
#      -E output.logstash.hosts=["${FILEBEAT_LOGSTASH_HOST:-logstash:5044}"]
#    volumes:
#      - /var/lib/docker/containers:/var/lib/docker/containers:ro
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#    networks:
#      - internal
#      - stroppy-net
#
#  vector:
#    image: ${VECTOR_IMAGE:-timberio/vector:latest-alpine}
#    profiles: ["vector"]
#    container_name: ${CLUSTER_NAME:-pg}-vector
#    hostname: vector
#    restart: unless-stopped
#    environment:
#      VECTOR_SINK_ENDPOINT: ${VECTOR_SINK_ENDPOINT:-http://localhost:8686}
#    volumes:
#      - /var/lib/docker/containers:/var/lib/docker/containers:ro
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#    networks:
#      - internal
#      - stroppy-net

  # ════════════════════════════════════════
  # BACKUP SERVICE
  # ════════════════════════════════════════
  backup:
    image: ${PG_IMAGE:-postgres:17}
    profiles: ["backup"]
    container_name: ${CLUSTER_NAME:-pg}-backup
    hostname: backup
    restart: unless-stopped
    environment:
      PGHOST: ${BACKUP_PG_HOST:-postgres}
      PGPORT: "5432"
      PGUSER: ${PG_USER:-postgres}
      PGPASSWORD: ${PG_PASSWORD:-postgres}
      PGDATABASE: ${PG_DATABASE:-postgres}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
      BACKUP_RETENTION: ${BACKUP_RETENTION:-7d}
      BACKUP_TOOL: ${BACKUP_TOOL:-pg_dump}
      # S3 storage (wal-g)
      AWS_ACCESS_KEY_ID: ${BACKUP_S3_ACCESS_KEY:-}
      AWS_SECRET_ACCESS_KEY: ${BACKUP_S3_SECRET_KEY:-}
      AWS_DEFAULT_REGION: ${BACKUP_S3_REGION:-}
      WALG_S3_PREFIX: ${BACKUP_S3_BUCKET:-}
      AWS_ENDPOINT: ${BACKUP_S3_ENDPOINT:-}
      # Local storage
      BACKUP_LOCAL_PATH: ${BACKUP_LOCAL_PATH:-/backups}
    volumes:
      - backup_data:${BACKUP_LOCAL_PATH:-/backups}
    networks:
      - internal
    command: ["sh", "-c", "echo 'Backup service ready'; sleep infinity"]

networks:
  internal:
    driver: bridge
  stroppy-net:
    name: ${SHARED_NETWORK:-stroppy-net}
    external: true

volumes:
  pg_data:
  patroni_1_data:
  patroni_2_data:
  patroni_3_data:
  etcd_1_data:
  etcd_2_data:
  etcd_3_data:
  etcd_4_data:
  etcd_5_data:
  backup_data:
