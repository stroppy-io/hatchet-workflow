syntax = "proto3";

package hatchet;

import "crossplane/deployment.proto";
import "database/database.proto";
import "stroppy/test.proto";
import "validate/validate.proto";

option go_package = "github.com/stroppy-io/hatchet-workflow/internal/proto/hatchet";

message Tasks {
    message Provision {
        message Input {
            crossplane.DeploymentSet.Request request = 1 [(validate.rules).message.required = true];
        }
        message Output {
            crossplane.DeploymentSet deployment_set = 1;
        }
    }

    /*
        Setup database for stroppy test if one of test.database_ref is Database
        This step can request provisioning of database if it is not already provisioned
    */
    message SetupDatabase {
        message Input {
            string run_id = 1 [(validate.rules).string.min_len = 1];
            database.Database database = 2 [(validate.rules).message.required = true];
        }
        message Output {
            // Connection string to deployed database
            string connection_string = 1 [(validate.rules).string.min_len = 1];
            crossplane.DeploymentSet deployment = 2 [(validate.rules).message.required = true];
        }
    }

    /*
        Setup stroppy vm using provisioning
    */
    message SetupStroppy {
        message Input {
            string run_id = 1 [(validate.rules).string.min_len = 1];
            string stroppy_version = 2;
            string bin_path = 3 [(validate.rules).string.min_len = 1];
            /* Never empty if database_ref is Database
               Needs to use same subnet policy with database_deployment_set from SetupDatabase
            */
            optional crossplane.DeploymentSet database_deployment_set = 4;
        }
        message Output {
            crossplane.Deployment deployment = 1 [(validate.rules).message.required = true];
            string bin_path = 2 [(validate.rules).string.min_len = 1];
        }
    }

    /*
        Run stroppy test
    */
    message RunStroppyTest {
        message Input {
            string run_id = 1 [(validate.rules).string.min_len = 1];
            string bin_path = 2 [(validate.rules).string.min_len = 1];
            map<string, string> stroppy_env = 3;
            string connection_string = 4 [(validate.rules).string.min_len = 1];
        }
        message Output {
            stroppy.TestResult result = 1 [(validate.rules).message.required = true];
        }
    }

    /*
        Run stroppy test
        This step can request database setup if one of test.database_ref is Database
    */
    message StroppyTestSuite {
        message Input {
            stroppy.TestSuite suite = 1 [(validate.rules).message.required = true];
        }
        message Output {
            stroppy.TestSuiteResult results = 1 [(validate.rules).message.required = true];
        }
    }
}

