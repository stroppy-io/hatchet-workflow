syntax = "proto3";

package database;

import "deployment/deployment.proto";
import "validate/validate.proto";

option go_package = "github.com/stroppy-io/hatchet-workflow/internal/proto/database";

message Postgres {

    // ── Shared configuration types ──────────────────────────────

    message Settings {
        enum StorageEngine {
            STORAGE_ENGINE_UNSPECIFIED = 0;
            STORAGE_ENGINE_HEAP = 1;
            STORAGE_ENGINE_ORIOLEDB = 2;
        }

        enum Version {
            VERSION_UNSPECIFIED = 0;
            VERSION_18 = 1;
            VERSION_17 = 2; // enable orioledb
            VERSION_16 = 3; // enable orioledb needed validation on setup
        }

        // Patroni wraps postgres runtime and is not modeled as a sidecar.
        message Patroni {
            bool enabled = 1;
            uint32 ttl = 2;
            uint32 loop_wait = 3;
            uint32 retry_timeout = 4;
            uint64 maximum_lag_on_failover = 5;  // bytes, default 1048576
            bool synchronous_mode = 6;
            uint32 synchronous_node_count = 7;   // default 1 when sync mode on
        }

        Version version = 1 [(validate.rules).enum.defined_only = true];
        StorageEngine storage_engine = 2 [(validate.rules).enum.defined_only = true];
        Patroni patroni = 3;
        map<string, string> postgresql_conf = 4;
    }

    message BackupConfig {
        enum Tool {
            TOOL_UNSPECIFIED = 0;
            WAL_G = 1;
            PG_DUMP = 2;
        }

        message S3Storage {
            string bucket = 1 [(validate.rules).string.min_len = 1];
            string region = 2 [(validate.rules).string.min_len = 1];
            string endpoint = 3 [(validate.rules).string.min_len = 1];
            string access_key_id = 4 [(validate.rules).string.min_len = 1];
            string secret_access_key = 5 [(validate.rules).string.min_len = 1];
        }

        message LocalStorage {
            string path = 1 [(validate.rules).string.min_len = 1];
        }

        string schedule = 1 [(validate.rules).string.min_len = 1];
        string retention = 2;
        Tool tool = 3 [(validate.rules).enum.defined_only = true];
        oneof storage {
            option (validate.required) = true;
            S3Storage s3 = 10;
            LocalStorage local = 12;
        }
    }

    message PgbouncerConfig {
        enum PoolMode {
            POOL_MODE_UNSPECIFIED = 0;
            SESSION = 1;
            TRANSACTION = 2;
            STATEMENT = 3;
        }

        uint32 pool_size = 1;
        PoolMode pool_mode = 2 [(validate.rules).enum.defined_only = true];
        uint32 max_client_conn = 3;
        optional uint32 port = 4 [(validate.rules).uint32 = {gte: 1, lte: 65535}];  // default 6432
    }

    message EtcdConfig {
        optional uint32 base_client_port = 1 [(validate.rules).uint32 = {gte: 1, lte: 65535}];  // default 2379
    }

    message NodeExporterConfig {
        optional uint32 port = 1 [(validate.rules).uint32 = {gte: 1, lte: 65535}];  // default 9100
        repeated string collectors = 2;
    }

    message PostgresExporterConfig {
        optional uint32 port = 1 [(validate.rules).uint32 = {gte: 1, lte: 65535}];  // default 9187
        repeated string custom_queries_paths = 2;
    }

    // ── Per-node service declarations ───────────────────────────

    message PostgresService {
        enum Role {
            ROLE_UNSPECIFIED = 0;
            ROLE_MASTER = 1;
            ROLE_REPLICA = 2;
        }

        Role role = 1 [(validate.rules).enum = {defined_only: true, not_in: [0]}];
        // Per-node settings override. If nil, cluster-level defaults apply.
        Settings settings = 2;
        // Merged on top of cluster defaults.postgresql_conf.
        map<string, string> postgresql_conf = 3;
    }

    message EtcdService {
        EtcdConfig config = 1;
        bool monitor = 2;  // attach node-exporter sidecar
    }

    message PgbouncerService {
        PgbouncerConfig config = 1 [(validate.rules).message.required = true];
        bool monitor = 2;  // attach pgbouncer-exporter sidecar
    }

    message BackupService {
        BackupConfig config = 1 [(validate.rules).message.required = true];
    }

    message MonitoringService {
        NodeExporterConfig node_exporter = 1;
        PostgresExporterConfig postgres_exporter = 2;
    }

    // ── Node: the central building block ────────────────────────

    message Node {
        // Unique name within the topology. Used as VM name suffix.
        string name = 1 [(validate.rules).string = {min_len: 1, max_len: 63, pattern: "^[a-z][a-z0-9-]*$"}];

        // Hardware for this node's VM.
        deployment.Hardware hardware = 2 [(validate.rules).message.required = true];

        // Services running on this node (all optional; at least one required — validated in Go).
        PostgresService    postgres   = 10;
        EtcdService        etcd       = 11;
        PgbouncerService   pgbouncer  = 12;
        BackupService      backup     = 13;
        MonitoringService  monitoring = 14;
    }

    // ── Top-level topology types ────────────────────────────────

    // Single standalone postgres instance (no cluster, no HA).
    message Instance {
        Settings defaults = 1 [(validate.rules).message.required = true];
        Node node = 2 [(validate.rules).message.required = true];
    }

    // Cluster: one master + N replicas + optional services on any node.
    message Cluster {
        // Cluster-wide default settings. Individual nodes can override
        // via node.postgres.settings / node.postgres.postgresql_conf.
        Settings defaults = 1 [(validate.rules).message.required = true];

        // All nodes in the cluster. Order is preserved for IP assignment.
        // System validates: exactly 1 master, etcd quorum, etc.
        repeated Node nodes = 2 [(validate.rules).repeated.min_items = 2];
    }
}
