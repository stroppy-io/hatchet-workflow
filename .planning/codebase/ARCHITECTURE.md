# Architecture

**Analysis Date:** 2026-02-27

## Pattern Overview

**Overall:** Distributed workflow orchestration with master/edge binary split

**Key Characteristics:**
- Two distinct binary roles: a stationary `master-worker` that orchestrates workflows, and ephemeral `edge-worker` binaries deployed to provisioned VMs
- All inter-service contracts defined as Protocol Buffers (`tools/proto/`, generated to `internal/proto/`)
- Hatchet (workflow engine backed by Postgres + RabbitMQ) is the task-scheduling bus; no direct HTTP API surface exists
- Domain logic is separated into `provision`, `deployment`, `edge`, and `managers` sub-packages under `internal/domain/`
- Infrastructure adapters (Terraform, Valkey, S3) are isolated under `internal/infrastructure/`

## Layers

**Entry Points (`cmd/`):**
- Purpose: Binary bootstrapping — wire dependencies and register Hatchet workers
- Location: `cmd/master-worker/master.go`, `cmd/edge-worker/edge.go`, `cmd/run/main.go`
- Contains: `main()` functions, env-var reading, Hatchet client setup
- Depends on: `internal/domain/workflows/`, `internal/core/`
- Used by: Docker images, Makefile targets

**Workflow Layer (`internal/domain/workflows/`):**
- Purpose: Define Hatchet DAGs — task ordering, timeouts, retries, on-failure hooks
- Location: `internal/domain/workflows/test/` (master-side), `internal/domain/workflows/edge/` (edge-side)
- Contains: `TestRunWorkflow`, `TestSuiteWorkflow`, `SetupContainersTask`, `InstallStroppy`, `RunStroppyTask`
- Depends on: `internal/domain/provision/`, `internal/domain/edge/`, `internal/proto/`, `internal/core/hatchet-ext/`
- Used by: `cmd/master-worker`, `cmd/edge-worker`

**Domain Services (`internal/domain/`):**
- Purpose: Business logic for provisioning, placement planning, network management, and container management
- Location: `internal/domain/provision/provision.go`, `internal/domain/deployment/deployment.go`, `internal/domain/managers/network.go`, `internal/domain/edge/`
- Contains: `ProvisionerService`, deployment `Registry`, `NetworkManager`, edge task ID helpers
- Depends on: `internal/infrastructure/`, `internal/proto/`
- Used by: Workflow layer

**Infrastructure Adapters (`internal/infrastructure/`):**
- Purpose: Wrap external systems — Terraform executor, Valkey client, S3
- Location: `internal/infrastructure/terraform/actor.go`, `internal/infrastructure/valkey/`, `internal/infrastructure/s3/`
- Contains: `Actor` (runs `terraform apply/destroy`), Valkey locker factory
- Depends on: External SDKs (`hashicorp/terraform-exec`, `valkey-io/valkey-go`)
- Used by: `internal/domain/deployment/yandex/`, `internal/domain/managers/`

**Deployment Backends (`internal/domain/deployment/`):**
- Purpose: Target-specific implementations of the `Service` interface (`CreateDeployment`, `DestroyDeployment`)
- Location: `internal/domain/deployment/yandex/yandex.go` (Terraform via Yandex Cloud), `internal/domain/deployment/docker/docker.go` (local Docker)
- Contains: `TerraformDeploymentService`, Docker `Service`, embedded `.tf` files, cloud-init scripting
- Depends on: `internal/infrastructure/terraform/`, Docker SDK, `internal/proto/`
- Used by: `internal/domain/provision/`

**Proto Contracts (`internal/proto/`):**
- Purpose: Generated Go types for all domain objects — workflow inputs/outputs, deployment templates, provision state, settings
- Location: `internal/proto/workflows/`, `internal/proto/provision/`, `internal/proto/deployment/`, `internal/proto/settings/`, `internal/proto/edge/`, `internal/proto/stroppy/`, `internal/proto/database/`
- Contains: `.pb.go`, `.pb.validate.go`, `.pb.json.go` files (generated by easyp/buf)
- Depends on: `google.golang.org/protobuf`, `envoyproxy/protoc-gen-validate`
- Used by: All layers

**Core Utilities (`internal/core/`):**
- Purpose: Cross-cutting helpers with no business logic
- Location: `internal/core/build/`, `internal/core/logger/`, `internal/core/hatchet-ext/`, `internal/core/uow/`, `internal/core/ids/`, `internal/core/ips/`, `internal/core/shutdown/`
- Contains: `WTask`/`PTask` generic Hatchet task wrappers, ULID ID generation, subnet IP allocation, logger setup, graceful shutdown, unit-of-work rollback
- Depends on: `rs/zerolog`, `google/uuid`, `oklog/ulid`
- Used by: Workflow layer, domain services

**Web Frontend (`web/`):**
- Purpose: React SPA for building test suite configurations and visualising topology
- Location: `web/src/App.tsx`, `web/src/components/`, `web/src/proto/`
- Contains: `TestWizard`, `SettingsEditor`, `TopologyCanvas`, protobuf-generated TypeScript types
- Depends on: React 19, `@xyflow/react`, `@bufbuild/protobuf`, Tailwind CSS, `framer-motion`
- Used by: End users via browser; no Go backend — pure static frontend

## Data Flow

**Test Suite Execution Flow:**

1. Operator runs `bin/run --file examples/test.yaml` → deserializes YAML into `Workflows_StroppyTestSuite_Input` (protobuf)
2. `cmd/run` calls `c.Run(SuiteWorkflowName, &input)` on the Hatchet client
3. Hatchet dispatches to `master-worker`'s `TestSuiteWorkflow` standalone task
4. Suite workflow calls `c.RunMany(RunWorkflowName, inputs)` — spawning one `stroppy-test-run` child workflow per test
5. Each `TestRunWorkflow` executes tasks in DAG order via Hatchet:
   - `validate-input` → `acquire-network` → `plan-placement-intent` → `build-placement` → `deploy-plan`
   - `deploy-plan` calls `ProvisionerService.DeployPlan` → `deployment.Registry.CreateDeployment`
   - For `TARGET_YANDEX_CLOUD`: `TerraformDeploymentService.CreateDeployment` runs `terraform apply` via `Actor`
   - For `TARGET_DOCKER`: `docker.Service.CreateDeployment` starts containers via Docker SDK
   - VMs/containers boot with cloud-init that launches `edge-worker` binary pointing back to Hatchet
6. `wait-workers-in-hatchet` polls `c.Workers().List()` until all expected edge workers appear
7. `run-database-containers`, `run-stroppy-containers` dispatch `SetupContainersTask` to edge workers via Hatchet (each task has a unique name per run ID)
8. `install-stroppy` dispatches `InstallStroppy` to stroppy edge workers — downloads binary from GitHub releases
9. `run-stroppy-test` dispatches `RunStroppyTask` — runs `stroppy gen` then `stroppy run`, streams stdout/stderr via `ctx.Log`
10. `destroy-plan` calls `ProvisionerService.DestroyPlan` + `DestroyNetwork` for cleanup
11. On any failure, `workflow.OnFailure` hook destroys provisioned infrastructure using previously stored parent task outputs

**Network Reservation Flow:**

1. `ProvisionerService.AcquireNetwork` determines required IP count from database template
2. `NetworkManager.ReserveNetwork` queries Valkey `SMEMBERS` for existing subnets, allocates a non-overlapping `/24` subnet, writes it back with `SADD`
3. Subnet CIDR is stored in the `deployment.Network` protobuf returned to the workflow

**State Management:**
- Workflow state is stored in Hatchet's Postgres-backed store; tasks pass typed outputs to children via `ctx.ParentOutput(parentTask, &dest)`
- Network allocation state is in Valkey (set membership, key pattern `network:{target}:{name}`)
- No application-level database; all persistent state flows through Hatchet or Valkey
- Terraform working directories are stored at `/tmp/stroppy-terraform/{deploymentId}/` on the master-worker host

## Key Abstractions

**`hatchet_ext.WTask` / `hatchet_ext.PTask`:**
- Purpose: Type-safe generic wrappers that let task functions accept/return concrete `*proto.Message` types instead of raw `any`
- Location: `internal/core/hatchet-ext/task.go`
- Pattern: `WTask[Input, Output]` for root tasks; `PTask[ParentOutput, Input, Output](parentTask, fn)` for dependent tasks that automatically unmarshal parent output

**`deployment.Registry`:**
- Purpose: Strategy pattern — maps `deployment.Target` enum values to the correct `Service` implementation
- Location: `internal/domain/deployment/deployment.go`
- Pattern: `Registry[Target]Service` map; callers invoke `registry.CreateDeployment(ctx, template)` without knowing the backend

**`ProvisionerService`:**
- Purpose: Orchestrates the full placement lifecycle: network reservation, IP planning, VM template construction, Hatchet cloud-init generation, deployment dispatch
- Location: `internal/domain/provision/provision.go`
- Pattern: Depends on `NetworkManager` and `DeploymentService` interfaces; wired in `internal/domain/workflows/test/deps.go`

**Edge Task Identifier (`edge.Task_Identifier`):**
- Purpose: Unique per-run, per-kind task names that allow the master workflow to dispatch to specific edge workers
- Location: `internal/domain/edge/edge.go`, `internal/proto/edge/`
- Pattern: String form `{kind}-{runId}-{taskId}` is passed as Hatchet worker/task name; parsed back by `edge-worker` on startup from `HATCHET_EDGE_ACCEPTABLE_TASKS` env var

**Proto-YAML (`internal/core/protoyaml/`):**
- Purpose: Deserialize user-provided YAML configuration files into protobuf messages with validation
- Location: `internal/core/protoyaml/`
- Pattern: Used by `cmd/run` to load `examples/*.yaml` → `Workflows_StroppyTestSuite_Input`

## Entry Points

**`cmd/master-worker` (long-running daemon):**
- Location: `cmd/master-worker/master.go`
- Triggers: Started by Docker Compose (`docker-compose.dev.yaml`) or directly
- Responsibilities: Registers `TestRunWorkflow` and `TestSuiteWorkflow` with Hatchet; blocks until interrupt

**`cmd/edge-worker` (ephemeral per-VM):**
- Location: `cmd/edge-worker/edge.go`
- Triggers: Cloud-init script on provisioned VMs, or Docker container startup
- Responsibilities: Parses `HATCHET_EDGE_ACCEPTABLE_TASKS` to determine which task kinds to register; registers `InstallStroppy`, `RunStroppyTask`, or `SetupContainersTask` as standalone Hatchet tasks; runs until SIGINT/SIGTERM then cleans up tracked Docker containers

**`cmd/run` (one-shot CLI runner):**
- Location: `cmd/run/main.go`
- Triggers: `make run-test` or direct invocation with `--file`
- Responsibilities: Parses a YAML test suite file, validates it, connects to Hatchet, triggers `stroppy-test-suite` workflow, waits for completion, prints YAML results to stdout

**`web/src/main.tsx` (frontend):**
- Location: `web/src/main.tsx`
- Triggers: Browser load; served by `vite dev` or static hosting
- Responsibilities: Mounts React app; `App.tsx` manages test suite configuration state using protobuf schemas, renders `TestWizard`, `SettingsEditor`, and `TopologyCanvas`

## Error Handling

**Strategy:** Errors propagate up the call stack and are returned as `error` from each layer; Hatchet retries tasks based on `WithRetries(N)` configuration; explicit cleanup on failure via `workflow.OnFailure` hook.

**Patterns:**
- Infrastructure errors are wrapped with `fmt.Errorf("description: %w", err)` at each layer boundary
- `internal/core/uow/uow.go` provides a `Uow` (unit of work) pattern for LIFO rollback of multi-step operations (used in Terraform apply to auto-destroy on failure)
- Workflow on-failure hook accesses previous task outputs via `ctx.ParentOutput(task, &dest)` to run cleanup even when intermediate tasks succeeded
- Edge worker cleanup on shutdown: `containers.Cleanup(ctx)` removes tracked Docker containers

## Cross-Cutting Concerns

**Logging:** `internal/core/logger/` wraps `rs/zerolog` and `go.uber.org/zap`; configured via `LOG_LEVEL`, `LOG_MOD`, `LOG_MAPPING`, `LOG_SKIP_CALLER` env vars; passed as `logger.Zerolog()` to Hatchet client; `ctx.Log(msg)` used inside Hatchet tasks for streaming task-scoped logs

**Validation:** All protobuf messages have `.Validate()` generated by `protoc-gen-validate`; validation is called explicitly at workflow start and in each task before processing

**Authentication:** No application-level auth; Hatchet token (`HATCHET_CLIENT_TOKEN`) is the only auth mechanism for both master and edge workers; Yandex Cloud credentials (`YC_TOKEN`, `YC_CLOUD_ID`, `YC_FOLDER_ID`, `YC_ZONE`) are injected via env vars into Terraform

---

*Architecture analysis: 2026-02-27*
